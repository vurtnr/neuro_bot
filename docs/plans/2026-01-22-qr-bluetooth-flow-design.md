# 二维码蓝牙连接流程设计文档

## 1. 数据流图

```
摄像头 → qr_node (识别) → /vision/result → brain_core (状态机)
                                                      │
                       ┌──────────────────────────────┼──────────────────────────────┐
                       ▼                              ▼                              ▼
                /audio/tts_play                  /robot/face_emotion         /iot/connect
                (语音播报)                       (表情切换)                    (蓝牙连接)
```

## 2. 二维码格式 (极简协议)

```json
{"t":"b","m":"D66562002A7E","c":"0A03000000258490"}
```

| 字段 | 含义 | 示例 |
|------|------|------|
| `t` | 类型标识 | `"b"` 表示 BLE |
| `m` | MAC 地址 | 去掉冒号的 12 位十六进制字符串 |
| `c` | Modbus 指令 | hex 字符串 |

## 3. brain_core 状态机

```
                    ┌──────────────────────────────────────┐
                    │           收到 VisionResult           │
                    └──────────────────┬───────────────────┘
                                       ▼
                              ┌────────────────┐
                              │  SCANNING      │ ───▶ 表情: BUSY
                              │  (扫描连接中)   │       语音: "已识别出二维码中的 MAC 地址，正在连接蓝牙设备"
                              └───────┬────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 │                 ▼
            蓝牙连接成功          超时/错误        设备不存在
                    │                 │                 │
                    ▼                 ▼                 ▼
           ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
           │ SENDING_CMD  │   │    IDLE      │   │    IDLE      │
           │ (下发指令中)  │   │   (空闲)     │   │   (空闲)     │
           └──────┬───────┘   └──────────────┘   └──────────────┘
                  │
                  ▼
           表情: HAPPY
           语音: "蓝牙设备已连接，并下发查询指令"
                  │
                  ▼
           发送指令到 iot_controller
                  │
                  ▼
           ┌──────────────┐
           │    IDLE      │ ◀─────────────────────┐
           │   (空闲)     │                       │
           └──────────────┘                       │
                                          指令发送失败/超时
```

## 4. 语音播报内容

| 阶段 | Topic | 播报内容 |
|------|-------|---------|
| 进入 SCANNING | `/audio/tts_play` | "已识别出二维码中的 MAC 地址，正在连接蓝牙设备" |
| 进入 SENDING_CMD | `/audio/tts_play` | "蓝牙设备已连接，并下发查询指令" |
| 连接/指令失败 | `/audio/tts_play` | "蓝牙连接失败，请重试" |

## 5. 表情切换

| 状态 | Topic | 表情指令 |
|------|-------|---------|
| SCANNING | `/robot/face_emotion` | `{"emotion":"busy"}` |
| SENDING_CMD | `/robot/face_emotion` | `{"emotion":"happy"}` |
| CONNECTION_FAILED | `/robot/face_emotion` | `{"emotion":"idle"}` |

## 6. 实现要点

### 6.1 状态定义

```rust
enum QrBluetoothState {
    Idle,
    Scanning,      // 扫描连接中
    SendingCmd,    // 下发指令中
}
```

### 6.2 消息处理

- 接收 `/vision/result` 话题，解析二维码数据
- 根据状态机流转控制表情和语音
- 通过 `/iot/connect` 发起蓝牙连接
- 通过 `/iot/send_cmd` 发送 Modbus 指令

### 6.3 错误处理

- 蓝牙连接超时：返回 IDLE 状态，播放失败语音
- 设备不存在：返回 IDLE 状态，播放失败语音
- 指令发送失败：返回 IDLE 状态，播放失败语音
